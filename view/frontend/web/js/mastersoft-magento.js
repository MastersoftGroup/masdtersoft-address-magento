define(["jquery","jquery/ui","harmony","domReady!"],function($){"use strict";function wait(){country&&$(country)&&$(country).val()&&window.Harmony?(clearTimeout(timeoutVar),selectedCountry=$("select"+country).val(),init(),main(selectedCountry)):(timeoutVar=setTimeout(wait,1e3),console.info("Waiting for knockout and Harmony"))}function getAdminConfigs(){var map={username:void 0,password:void 0,url:void 0,AU:{locale:Harmony.AUSTRALIA,sot:void 0,featureOptions:{}},NZ:{locale:Harmony.NEW_ZEALAND,sot:void 0,featureOptions:{}}},key=$("#keyConfig").val().trim(),url=$("#urlConfig").val().trim(),options=$("#optionsConfig").val().trim(),optionsAu=$("#optionsAuConfig").val().trim(),optionsNz=$("#optionsNzConfig").val().trim();if("undefined"!=typeof key&&key&&key.indexOf(":")>0){var i=key.indexOf(":"),username=key.substring(0,i),password=key.substring(i+1,key.length);if(username&&password){map.username=username,map.password=password,"undefined"!=typeof url&&url&&(map.url=url);var value,obj;"undefined"!=typeof options&&options&&(obj=eval("(["+options+"])")[0],Object.keys(obj).forEach(function(e){value=obj[e],"sot"!=e&&(map.AU.featureOptions[e]=value,map.NZ.featureOptions[e]=value)})),"undefined"!=typeof optionsAu&&optionsAu&&(obj=eval("(["+optionsAu+"])")[0],Object.keys(obj).forEach(function(e){value=obj[e],"sot"==e?map.AU.sot=value:map.AU.featureOptions[e]=value})),"undefined"!=typeof optionsNz&&optionsNz&&(obj=eval("(["+optionsNz+"])")[0],Object.keys(obj).forEach(function(e){value=obj[e],"sot"==e?map.NZ.sot=value:map.NZ.featureOptions[e]=value}))}}return console.info("License key: "+key+", URL: "+url+", Options: "+options+", AU Options: "+optionsAu+", NZ Options: "+optionsNz),map}function init(){$('[name="street[0]"]').length?(line1='[name="street[0]"]',line2='[name="street[1]"]',addressForm=shippingAddressForm):(line1="#street_1",line2="#street_2",addressForm=customerAddressForm),city='[name="city"]',region='[name="region"]',postcode='[name="postcode"]',configs=getAdminConfigs()}function main(e){function o(e,o,n,t,s,r){function i(e,o){$(e).val(d(o)),$(addressForm+city).val(u(t,o)),$(addressForm+city).attr("readonly",!0),$(addressForm+city).trigger("keyup"),$(addressForm+region).val(l(t,o)),$(addressForm+region).attr("readonly",!0),$(addressForm+region).trigger("keyup"),$(addressForm+postcode).val(o.postcode),$(addressForm+postcode).attr("readonly",!0),$(addressForm+postcode).trigger("keyup")}function a(e,o){for(var n=[],t=0;t<e.length;t++)"undefined"!=typeof e[t]&&e[t]&&e[t].trim()&&n.push(e[t]);return n.join(o)}function d(e){return a([e.building,e.subdwelling,e.postal,e.street],", ")}function u(e,o){return e==Harmony.AUSTRALIA?o.locality:e==Harmony.NEW_ZEALAND?o.suburb?o.suburb:o.townCity:void 0}function l(e,o){return e==Harmony.AUSTRALIA?o.state.toUpperCase():e==Harmony.NEW_ZEALAND?o.townCity.toUpperCase():void 0}Harmony.useEnv(e),Harmony.init(o,n,t),Harmony.useProtocol(Harmony.JSONP),Harmony.useFeatureOptions(r),$(addressForm+line1).autocomplete({minLength:3,delay:500,source:function(e,o){Harmony.address({fullAddress:e.term},s,function(e){var n=[];e.status==Harmony.SUCCESS?(n=$.map(e.payload,function(e){return{label:e.fullAddress,building:e.buildingName,subdwelling:e.subdwelling,street:e.streetNumber+" "+e.street,postal:e.postal,locality:e.locality,state:e.state,suburb:e.suburb,townCity:e.townCity,postcode:e.postcode}}),o(n)):console.info(e.messages&&e.messages.length>0?e.messages[0]:"Request is not successful. Please contact admin.")})},open:function(e){var o=$("<img />",{src:LOGO_SRC,alt:"",align:"right"});o.click(function(){$(e.target).autocomplete("close")}),$(this).autocomplete("widget").append(o),$(this).autocomplete("widget").zIndex(900)},focus:function(e,o){e.preventDefault(),i(this,o.item)},select:function(e,o){e.preventDefault(),i(this,o.item)}})}var n,t,s=void 0;e&&configs&&!isEmpty(configs)&&"undefined"!=typeof configs[e]&&configs[e]&&(n=configs[e.toUpperCase()].locale,t=configs[e.toUpperCase()].sot,s=configs[e.toUpperCase()].featureOptions);var r=configs.username,i=configs.password,a=configs.url;"undefined"!=typeof n&&n&&"undefined"!=typeof t&&t&&"undefined"!=typeof r&&r&&"undefined"!=typeof i&&i?($(addressForm+line1).autocomplete({disabled:!1}),o(a,r,i,n,t,s)):$(addressForm+line1).autocomplete({disabled:!0})}function printout(e,o){console.log(o+"=");var n=0;$.each(e,function(e,o){if("Object"==typeof o||o instanceof Object)printout(o,e);else{n+=2;for(var t="",s=0;n>s;s++)t+=" ";console.log(t+e+": "+o),n-=2}})}function isEmpty(e){for(var o in e)return!e.hasOwnProperty(o);return!0}console.info("jquery version "+$.fn.jquery),$.ui?console.info("jquery ui is loaded - version "+$.ui.version):console.warn("jquery ui is NOT loaded");var LOGO_SRC="https://s3-ap-southeast-2.amazonaws.com/common.mastersoftgroup.com/styles/images/mastersoft/mastersoft-clear-logo.png",configs,addressForm="",line1,line2,city,region,postcode,shippingAddressForm="#shipping-new-address-form ",billingAddressForm="#billing-new-address-form ",customerAddressForm="#form-validate ",billingAddressChk='[name="billing-address-same-as-shipping"]',country='[name="country_id"]',timeoutVar,selectedCountry;wait(),$(document).on("change",addressForm+country,function(){selectedCountry=$(addressForm+"select"+country).val(),selectedCountry&&"undefined"!=typeof selectedCountry&&($(addressForm+line1).val(""),$(addressForm+line2).val(""),$(addressForm+city).val(""),$(addressForm+region).val(""),$(addressForm+postcode).val(""),main(selectedCountry))}),$(document).on("change",billingAddressChk,function(){var e=$(billingAddressChk).prop("checked");e?main(void 0):(addressForm=billingAddressForm,selectedCountry=$(billingAddressForm+"select"+country).val(),selectedCountry&&"undefined"!=typeof selectedCountry&&main(selectedCountry))}),$(window).bind("hashchange",function(){var e=window.location.pathname,o=window.location.hash;"/checkout/"==e&&"#payment"==o?(addressForm=billingAddressForm,selectedCountry=$(billingAddressForm+"select"+country).val(),selectedCountry&&"undefined"!=typeof selectedCountry&&main(selectedCountry)):"/checkout/"==e&&"#shipping"==o&&(addressForm=shippingAddressForm,selectedCountry=$(shippingAddressForm+"select"+country).val(),selectedCountry&&"undefined"!=typeof selectedCountry&&main(selectedCountry))})});